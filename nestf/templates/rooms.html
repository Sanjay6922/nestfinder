{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Room Listings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{% static 'img/NestFinder icon.png' %}" />
    <style>
        body { font-family: 'Poppins', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .swiper-container { height: 400px; overflow: hidden; }
        .swiper-slide img { width: 100%; height: 100%; object-fit: cover; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 50; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-content { background: white; border-radius: 1rem; box-shadow: 0 20px 25px rgba(0,0,0,0.25); max-width: 480px; width: 90%; overflow: hidden; animation: bounceIn .3s ease-out; }
        .modal-header { background: linear-gradient(135deg, #4f46e5, #2e1065); color: white; padding: 1.25rem; border-top-left-radius: 1rem; border-top-right-radius: 1rem; }
        .modal-body { padding: 1.5rem; background: #f9fafb; }
        .modal-close-btn { background: #ef4444; color: white; padding: .75rem; border-radius: .5rem; transition: transform .2s, background .2s; font-weight: 600; letter-spacing: 0.5px; }
        .modal-close-btn:hover { background: #dc2626; transform: scale(1.05); }
        @keyframes bounceIn { 0% { transform: scale(.9); opacity: 0; } 60% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); } }
        .wishlist-btn { position: absolute; top: 10px; right: 10px; z-index: 10; cursor: pointer; transition: transform .2s ease-in-out; background-color: rgba(255,255,255,0.9); border-radius: 50%; padding: 8px; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
        .wishlist-btn:hover { transform: scale(1.1); }
        .wishlist-btn svg { transition: fill .3s ease, stroke .3s ease; }
        .wishlist-btn.active svg { fill: #ef4444; stroke: none; }
        .share-btn { position: absolute; top: 10px; right: 60px; z-index: 10; cursor: pointer; background-color: rgba(255,255,255,0.9); border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease, background-color 0.2s ease; }
        .share-btn:hover { transform: scale(1.1); background-color: #25D366; }
        .share-btn:hover svg { color: white; }
        .share-tooltip { position: absolute; top: 55px; right: 40px; background-color: rgba(0,0,0,0.75); color: white; font-size: 12px; padding: 4px 8px; border-radius: 4px; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; white-space: nowrap; }
        .share-btn:hover .share-tooltip { opacity: 1; visibility: visible; }
        .feature-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-right: 4px; margin-bottom: 4px; background-color: #e0e7ff; color: #4f46e5; transition: background-color 0.2s; }
        .feature-badge:hover { background-color: #c7d2fe; }
        .swiper-pagination-bullet { width: 10px; height: 10px; background: white; opacity: 0.8; }
        .swiper-pagination-bullet-active { background: #4f46e5; transform: scale(1.2); }
        .price-tags-container { margin-bottom: 40px; position: absolute; bottom: 15px; left: 15px; display: flex; gap: 50px; align-items: center; z-index: 10; }
        .price-tag { background: rgba(79,70,229,0.85); color: white; padding: 7px 14px; border-radius: 6px; font-weight: 600; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); backdrop-filter: blur(3px); border: 1px solid rgba(255,255,255,0.2); white-space: nowrap; }
        .availability-badge { position: absolute; top: 10px; left: 10px; z-index: 10; padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .available { background-color: rgba(16,185,129,0.9); color: white; }
        .not-available { background-color: rgba(239,68,68,0.9); color: white; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div class="container mx-auto px-4 py-10 max-w-7xl">
        <header class="mb-10 text-center">
            <h1 class="text-4xl font-extrabold text-indigo-900 mb-3">Premium Room Listings</h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto mb-6">Discover affordable accommodations tailored to your lifestyle and budget needs.</p>
            <a href="{% url 'userhome' %}" class="inline-block text-indigo-600 hover:text-indigo-800 font-medium hover:underline transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Back
            </a>
        </header>

        {% csrf_token %}
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

        <!-- Filter Section with Sorting -->
        <div class="bg-white p-6 rounded-2xl shadow-md mb-8 border border-gray-100">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Filter Rooms</h2>
            <form id="filter-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4">
                <div>
                    <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                    <input type="text" name="location" id="location" placeholder="Enter location" value="{{ request.GET.location }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors" />
                </div>
                <div>
                    <label for="min_price" class="block text-sm font-medium text-gray-700 mb-1">Min Price (₹)</label>
                    <input type="number" name="min_price" id="min_price" placeholder="Min price" min="0" value="{{ request.GET.min_price }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors" />
                </div>
                <div>
                    <label for="max_price" class="block text-sm font-medium text-gray-700 mb-1">Max Price (₹)</label>
                    <input type="number" name="max_price" id="max_price" placeholder="Max price" min="0" value="{{ request.GET.max_price }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors" />
                </div>
                <div>
                    <label for="sort_by" class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                    <select name="sort_by" id="sort_by" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                        <option value="" {% if not request.GET.sort_by %}selected{% endif %}>Default</option>
                        <option value="price_asc" {% if request.GET.sort_by == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
                        <option value="price_desc" {% if request.GET.sort_by == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
                        <option value="name_asc" {% if request.GET.sort_by == 'name_asc' %}selected{% endif %}>Name: A to Z</option>
                        <option value="name_desc" {% if request.GET.sort_by == 'name_desc' %}selected{% endif %}>Name: Z to A</option>
                    </select>
                </div>
                <div class="flex items-end gap-2">
                    <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors duration-200">Apply Filters</button>
                    <button type="button" id="clear-filters" class="w-full text-center bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors duration-200">Clear Filters</button>
                </div>
            </form>
        </div>

        <!-- Search Box -->
        <div class="bg-white p-6 rounded-2xl shadow-md mb-8 border border-gray-100">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Search Rooms</h2>
            <div class="relative">
                <input type="text" id="search-box" placeholder="Search by room name..." class="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors text-gray-700" />
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
        </div>

        <!-- Room Listings -->
        <div class="grid grid-cols-1 gap-8" id="room-listings">
            {% if rooms_list %}
            {% for room in rooms_list %}
            <div class="bg-white border border-gray-200 rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl relative room-item" data-name="{{ room.name|lower }}">
                <div class="availability-badge {% if room.availability %}available{% else %}not-available{% endif %}">
                    {% if room.availability %}Available Now{% else %}Not Available{% endif %}
                </div>
                <div class="wishlist-btn {% if room.id in wishlist %}active{% endif %}" data-room-id="{{ room.id }}" onclick="toggleRoomWishlist(this)">
                    <svg class="h-5 w-5 text-gray-700" fill="{% if room.id in wishlist %}#ef4444{% else %}none{% endif %}" stroke="{% if room.id in wishlist %}none{% else %}currentColor{% endif %}" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                </div>
                <div class="share-btn" onclick="shareOnWhatsApp('{{ room.name }}', '{{ room.location }}', {{ room.price }})">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                    </svg>
                    <span class="share-tooltip">Share on WhatsApp</span>
                </div>
                <div class="flex flex-col md:flex-row">
                    <div class="md:w-1/2 relative">
                        <div class="swiper-container w-full">
                            <div class="swiper-wrapper">
                                {% for image in room.images.all %}
                                <div class="swiper-slide"><img src="{{ image.image.url }}" alt="{{ room.name }}" class="transition-transform duration-500 hover:scale-105"/></div>
                                {% empty %}
                                <div class="swiper-slide bg-gray-100 flex items-center justify-center"><p class="text-center text-gray-500 py-16">No images available</p></div>
                                {% endfor %}
                            </div>
                            <div class="swiper-pagination"></div>
                        </div>
                        <div class="price-tags-container">
                            <div class="price-tag"><span class="font-normal mr-1">M:</span>₹{{ room.price }}</div>
                            {% if room.weekly_price %}<div class="price-tag"><span class="font-normal mr-1">W:</span>₹{{ room.weekly_price }}</div>{% endif %}
                            {% if room.daily_price %}<div class="price-tag"><span class="font-normal mr-1">D:</span>₹{{ room.daily_price }}</div>{% endif %}
                        </div>
                    </div>
                    <div class="md:w-1/2 p-6 flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-start mb-3"><h2 class="text-2xl font-bold text-gray-900">{{ room.name }}</h2></div>
                            <div class="flex items-center mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <p class="ml-2 text-gray-700 font-medium">{{ room.location }}</p>
                            </div>
                            <div class="bg-indigo-50 p-4 rounded-xl mb-4">
                                <h3 class="text-base font-semibold text-indigo-800 mb-2">Description</h3>
                                <p class="text-gray-700 text-sm">{{ room.description }}</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-4">
                                <h3 class="text-base font-semibold text-gray-700 mb-2">Contact Information</h3>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    {% if room.phone_number %}
                                    <div class="flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684 .949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                        </svg>
                                        <span class="ml-2">{{ room.phone_number }}</span>
                                    </div>
                                    {% endif %}
                                    {% if room.email %}
                                    <div class="flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                        </svg>
                                        <span class="ml-2 truncate">{{ room.email }}</span>
                                    </div>
                                    {% endif %}
                                    {% if room.whatsapp_number %}
                                    <div class="flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12.992 13.135a.643.643 0 01-.235-.047c-.329-.141-1.019-.501-1.45-.896-.266-.243-.543-.535-.81-.855a7.077 7.077 0 01-1.256-2.007.634.634 0 01.141-.678c.141-.165.329-.353.517-.542.094-.094.188-.188.282-.282.235-.235.423-.423.564-.564a.965.965 0 00.141-1.161c-.094-.188-.657-1.542-1.065-2.101-.188-.282-.376-.4-.657-.4-.047 0-.094 0-.141.047l-.047.047c-.423.423-.75.75-1.019 1.019-1.019 1.019-1.966 2.101-.14 5.224 1.684 2.959 3.697 4.784 6.562 5.989l.04.005c.282.141.517.235.75.282a1.01 1.01 0 00.75-.282c.282-.235.61-.562.99-.99.376-.423.282-1.019-.141-1.355-.047 0-.094-.047-.141-.094l-1.45-1.019a.632.632 0 00-.376-.141z"/>
                                        </svg>
                                        <span class="ml-2">{{ room.whatsapp_number }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="mb-4">
                                <h3 class="text-base font-semibold text-gray-700 mb-2">Room Features</h3>
                                <div class="flex flex-wrap">
                                    {% for feature in room.features.all %}
                                    <span class="feature-badge">{{ feature.name }}</span>
                                    {% empty %}
                                    <span class="feature-badge bg-gray-100 text-gray-500 italic">No features listed</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="mb-4">
                                <h3 class="text-base font-semibold text-gray-700 mb-2">Nearby Places</h3>
                                <select class="nearby-select w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-150 text-sm" data-room-id="{{ room.id }}">
                                    <option value="" selected>Select a place</option>
                                    <option value="hospital">Hospitals</option>
                                    <option value="supermarket">Supermarkets</option>
                                    <option value="bus_stop">Bus Stops</option>
                                    <option value="restaurant">Restaurants</option>
                                    <option value="park">Parks</option>
                                    <option value="famous_spots">Famous Spots</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-3">
                            <a href="https://www.google.com/maps/search/?api=1&query={{ room.location|urlencode }}" target="_blank" class="flex-1 text-center bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center space-x-2 text-sm font-medium shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span>View on Map</span>
                            </a>
                            <a href="https://wa.me/{{ room.whatsapp_number }}?text=Hello,%20I'm%20interested%20in%20your%20room:%20{{ room.name|urlencode }}.%20Can%20you%20provide%20more%20details?" class="flex-1 text-center bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center space-x-2 text-sm font-medium shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12.992 13.135a.643.643 0 01-.235-.047c-.329-.141-1.019-.501-1.45-.896-.266-.243-.543-.535-.81-.855a7.077 7.077 0 01-1.256-2.007.634.634 0 01.141-.678c.141-.165.329-.353.517-.542.094-.094.188-.188.282-.282.235-.235.423-.423.564-.564a.965.965 0 00.141-1.161c-.094-.188-.657-1.542-1.065-2.101-.188-.282-.376-.4-.657-.4-.047 0-.094 0-.141.047l-.047.047c-.423.423-.75.75-1.019 1.019-1.019 1.019-1.966 2.101-.14 5.224 1.684 2.959 3.697 4.784 6.562 5.989l.04.005c.282.141.517.235.75.282a1.01 1.01 0 00.75-.282c.282-.235.61-.562.99-.99.376-.423.282-1.019-.141-1.355-.047 0-.094-.047-.141-.094l-1.45-1.019a.632.632 0 00-.376-.141z"/>
                                </svg>
                                <span>Contact Now</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div id="modal-{{ room.id }}" class="modal">
                <div class="modal-content">
                    <div class="modal-header"><h3 class="text-lg font-semibold" id="modal-title-{{ room.id }}"></h3></div>
                    <div class="modal-body" id="modal-body-{{ room.id }}"></div>
                    <button class="modal-close-btn w-full" onclick="closeModal('modal-{{ room.id }}')">Close</button>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-12 bg-white rounded-2xl shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="text-2xl font-semibold text-gray-600 mb-2">No Rooms Available</h2>
                <p class="text-gray-500">Please check back later for new listings.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        const roomsUrl = "{% url 'rooms' %}";
        const toggleWishlistUrl = "{% url 'toggle_wishlist' %}";

        // Initialize Swiper on page load
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.swiper-container').forEach(container => {
                new Swiper(container, {
                    loop: true,
                    autoplay: { delay: 3500, disableOnInteraction: false },
                    pagination: { el: '.swiper-pagination', clickable: true },
                    effect: 'fade',
                    fadeEffect: { crossFade: true }
                });
            });
        });

        // Handle form submission with AJAX
        document.getElementById('filter-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const url = new URL(roomsUrl, window.location.origin);
            for (const [key, value] of formData.entries()) {
                if (value) url.searchParams.set(key, value);
            }
            console.log('Form Data:', Object.fromEntries(formData));
            console.log('Request URL:', url.toString());
            fetchData(url);
        });

        // Handle Clear Filters
        document.getElementById('clear-filters').addEventListener('click', function() {
            document.getElementById('filter-form').reset();
            document.getElementById('search-box').value = '';
            const url = new URL(roomsUrl, window.location.origin);
            fetchData(url);
        });

        // Fetch data and update listings
        function fetchData(url) {
            fetch(url, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => {
                if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log('Received data:', data);
                updateRoomListings(data.rooms);
                applySearchFilter();
            })
            .catch(error => console.error('Error fetching rooms:', error));
        }

        // Update Room Listings
        function updateRoomListings(rooms) {
            const container = document.getElementById('room-listings');
            container.innerHTML = '';

            if (!rooms.length) {
                container.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-2xl shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h2 class="text-2xl font-semibold text-gray-600 mb-2">No Rooms Available</h2>
                        <p class="text-gray-500">Please check back later for new listings.</p>
                    </div>`;
                return;
            }

            rooms.forEach(room => {
                const roomHtml = `
                    <div class="bg-white border border-gray-200 rounded-2xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl relative room-item" data-name="${room.name.toLowerCase()}">
                        <div class="availability-badge ${room.availability ? 'available' : 'not-available'}">${room.availability ? 'Available Now' : 'Not Available'}</div>
                        <div class="wishlist-btn ${room.in_wishlist ? 'active' : ''}" data-room-id="${room.id}" onclick="toggleRoomWishlist(this)">
                            <svg class="h-5 w-5 text-gray-700" fill="${room.in_wishlist ? '#ef4444' : 'none'}" stroke="${room.in_wishlist ? 'none' : 'currentColor'}" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                            </svg>
                        </div>
                        <div class="share-btn" onclick="shareOnWhatsApp('${room.name}', '${room.location}', ${room.price})">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                            </svg>
                            <span class="share-tooltip">Share on WhatsApp</span>
                        </div>
                        <div class="flex flex-col md:flex-row">
                            <div class="md:w-1/2 relative">
                                <div class="swiper-container w-full">
                                    <div class="swiper-wrapper">
                                        ${room.images.length ? room.images.map(img => `<div class="swiper-slide"><img src="${img}" alt="${room.name}" class="transition-transform duration-500 hover:scale-105"/></div>`).join('') : `<div class="swiper-slide bg-gray-100 flex items-center justify-center"><p class="text-center text-gray-500 py-16">No images available</p></div>`}
                                    </div>
                                    <div class="swiper-pagination"></div>
                                </div>
                                <div class="price-tags-container">
                                    <div class="price-tag"><span class="font-normal mr-1">M:</span>₹${room.price}</div>
                                    ${room.weekly_price ? `<div class="price-tag"><span class="font-normal mr-1">W:</span>₹${room.weekly_price}</div>` : ''}
                                    ${room.daily_price ? `<div class="price-tag"><span class="font-normal mr-1">D:</span>₹${room.daily_price}</div>` : ''}
                                </div>
                            </div>
                            <div class="md:w-1/2 p-6 flex flex-col justify-between">
                                <div>
                                    <div class="flex justify-between items-start mb-3"><h2 class="text-2xl font-bold text-gray-900">${room.name}</h2></div>
                                    <div class="flex items-center mb-4">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        </svg>
                                        <p class="ml-2 text-gray-700 font-medium">${room.location}</p>
                                    </div>
                                    <div class="bg-indigo-50 p-4 rounded-xl mb-4">
                                        <h3 class="text-base font-semibold text-indigo-800 mb-2">Description</h3>
                                        <p class="text-gray-700 text-sm">${room.description}</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-4">
                                        <h3 class="text-base font-semibold text-gray-700 mb-2">Contact Information</h3>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            ${room.phone_number ? `<div class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684 .949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg><span class="ml-2">${room.phone_number}</span></div>` : ''}
                                            ${room.email ? `<div class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg><span class="ml-2 truncate">${room.email}</span></div>` : ''}
                                            ${room.whatsapp_number ? `<div class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12.992 13.135a.643.643 0 01-.235-.047c-.329-.141-1.019-.501-1.45-.896-.266-.243-.543-.535-.81-.855a7.077 7.077 0 01-1.256-2.007.634.634 0 01.141-.678c.141-.165.329-.353.517-.542.094-.094.188-.188.282-.282.235-.235.423-.423.564-.564a.965.965 0 00.141-1.161c-.094-.188-.657-1.542-1.065-2.101-.188-.282-.376-.4-.657-.4-.047 0-.094 0-.141.047l-.047.047c-.423.423-.75.75-1.019 1.019-1.019 1.019-1.966 2.101-.14 5.224 1.684 2.959 3.697 4.784 6.562 5.989l.04.005c.282.141.517.235.75.282a1.01 1.01 0 00.75-.282c.282-.235.61-.562.99-.99.376-.423.282-1.019-.141-1.355-.047 0-.094-.047-.141-.094l-1.45-1.019a.632.632 0 00-.376-.141z"/></svg><span class="ml-2">${room.whatsapp_number}</span></div>` : ''}
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <h3 class="text-base font-semibold text-gray-700 mb-2">Room Features</h3>
                                        <div class="flex flex-wrap">
                                            ${room.features && room.features.length ? room.features.map(f => `<span class="feature-badge">${f.name}</span>`).join('') : `<span class="feature-badge bg-gray-100 text-gray-500 italic">No features listed</span>`}
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <h3 class="text-base font-semibold text-gray-700 mb-2">Nearby Places</h3>
                                        <select class="nearby-select w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-150 text-sm" data-room-id="${room.id}">
                                            <option value="" selected>Select a place</option>
                                            <option value="hospital">Hospitals</option>
                                            <option value="supermarket">Supermarkets</option>
                                            <option value="bus_stop">Bus Stops</option>
                                            <option value="restaurant">Restaurants</option>
                                            <option value="park">Parks</option>
                                            <option value="famous_spots">Famous Spots</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-4 flex space-x-3">
                                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(room.location)}" target="_blank" class="flex-1 text-center bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center space-x-2 text-sm font-medium shadow-md">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        </svg>
                                        <span>View on Map</span>
                                    </a>
                                    <a href="https://wa.me/${room.whatsapp_number}?text=Hello,%20I'm%20interested%20in%20your%20room:%20${encodeURIComponent(room.name)}.%20Can%20you%20provide%20more%20details?" class="flex-1 text-center bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center space-x-2 text-sm font-medium shadow-md">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12.992 13.135a.643.643 0 01-.235-.047c-.329-.141-1.019-.501-1.45-.896-.266-.243-.543-.535-.81-.855a7.077 7.077 0 01-1.256-2.007.634.634 0 01.141-.678c.141-.165.329-.353.517-.542.094-.094.188-.188.282-.282.235-.235.423-.423.564-.564a.965.965 0 00.141-1.161c-.094-.188-.657-1.542-1.065-2.101-.188-.282-.376-.4-.657-.4-.047 0-.094 0-.141.047l-.047.047c-.423.423-.75.75-1.019 1.019-1.019 1.019-1.966 2.101-.14 5.224 1.684 2.959 3.697 4.784 6.562 5.989l.04.005c.282.141.517.235.75.282a1.01 1.01 0 00.75-.282c.282-.235.61-.562.99-.99.376-.423.282-1.019-.141-1.355-.047 0-.094-.047-.141-.094l-1.45-1.019a.632.632 0 00-.376-.141z"/>
                                        </svg>
                                        <span>Contact Now</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="modal-${room.id}" class="modal">
                        <div class="modal-content">
                            <div class="modal-header"><h3 class="text-lg font-semibold" id="modal-title-${room.id}"></h3></div>
                            <div class="modal-body" id="modal-body-${room.id}"></div>
                            <button class="modal-close-btn w-full" onclick="closeModal('modal-${room.id}')">Close</button>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', roomHtml);

                // Initialize Swiper for the newly added container
                const swiperContainer = container.lastElementChild.querySelector('.swiper-container');
                new Swiper(swiperContainer, {
                    loop: true,
                    autoplay: { delay: 3500, disableOnInteraction: false },
                    pagination: { el: '.swiper-pagination', clickable: true },
                    effect: 'fade',
                    fadeEffect: { crossFade: true }
                });
            });
        }

        // Search Functionality
        document.getElementById('search-box').addEventListener('input', applySearchFilter);
        function applySearchFilter() {
            const searchTerm = document.getElementById('search-box').value.toLowerCase().trim();
            const roomItems = document.querySelectorAll('.room-item');
            const container = document.getElementById('room-listings');

            let hasMatches = false;
            roomItems.forEach(item => {
                const name = item.getAttribute('data-name');
                if (name.includes(searchTerm)) {
                    item.style.display = 'block';
                    hasMatches = true;
                } else {
                    item.style.display = 'none';
                }
            });

            if (!hasMatches && searchTerm) {
                container.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-2xl shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h2 class="text-2xl font-semibold text-gray-600 mb-2">No Matching Rooms</h2>
                        <p class="text-gray-500">Try a different search term.</p>
                    </div>`;
            } else if (!searchTerm && roomItems.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 bg-white rounded-2xl shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h2 class="text-2xl font-semibold text-gray-600 mb-2">No Rooms Available</h2>
                        <p class="text-gray-500">Please check back later for new listings.</p>
                    </div>`;
            }
        }

        // Nearby Places Modal Logic
        document.querySelectorAll('.nearby-select').forEach(select => {
            select.addEventListener('change', function() {
                const roomId = this.getAttribute('data-room-id');
                const placeType = this.value;
                const modal = document.getElementById(`modal-${roomId}`);
                const modalTitle = document.getElementById(`modal-title-${roomId}`);
                const modalBody = document.getElementById(`modal-body-${roomId}`);

                if (placeType) {
                    const nearbyPlaces = {
                        {% for room in rooms_list %}
                        "{{ room.id }}": {
                            {% for place in room.nearest_places.all %}
                            "{{ place.place_type }}": [
                                {% for p in room.nearest_places.all %}
                                {% if p.place_type == place.place_type %}
                                {name: "{{ p.name }}", distance: "{{ p.distance }} km"},
                                {% endif %}
                                {% endfor %}
                            ],
                            {% endfor %}
                        },
                        {% endfor %}
                    };
                    const places = nearbyPlaces[roomId]?.[placeType] || [];
                    modalTitle.textContent = `${placeType.charAt(0).toUpperCase() + placeType.slice(1)} Near ${this.closest('.flex').querySelector('h2').textContent}`;
                    modalBody.innerHTML = places.length ? places.map(place => `
                        <div class="flex items-center space-x-3 p-2 mb-2 bg-indigo-50 rounded-lg">
                            <div class="flex-shrink-0 bg-indigo-100 p-2 rounded-md">
                                <svg class="h-5 w-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </div>
                            <div>
                                <p class="font-medium">${place.name}</p>
                                <p class="text-sm text-gray-500">${place.distance}</p>
                            </div>
                        </div>`).join('') : `
                        <div class="text-center py-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p class="text-gray-500 italic">No ${placeType} found nearby.</p>
                        </div>`;
                    modal.style.display = 'flex';
                }
            });
        });

        // Modal Close Functions
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        document.querySelectorAll('.modal').forEach(modal => modal.addEventListener('click', e => e.target === modal && closeModal(modal.id)));

        // Toggle Room Wishlist
        function toggleRoomWishlist(element) {
            const roomId = element.getAttribute('data-room-id');
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            const heartIcon = element.querySelector('svg');

            fetch(toggleWishlistUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `room_id=${roomId}`
            })
            .then(response => {
                if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.added === true) {
                    element.classList.add('active');
                    heartIcon.setAttribute('fill', '#ef4444');
                    heartIcon.setAttribute('stroke', 'none');
                    console.log(`Room ${roomId} added to wishlist`);
                } else if (data.added === false) {
                    element.classList.remove('active');
                    heartIcon.setAttribute('fill', 'none');
                    heartIcon.setAttribute('stroke', 'currentColor');
                    console.log(`Room ${roomId} removed from wishlist`);
                } else if (data.error) {
                    console.error('Error:', data.error);
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Wishlist toggle error:', error);
                alert('Failed to update wishlist. Please try again.');
            });
        }

        // Share on WhatsApp
        function shareOnWhatsApp(name, location, price) {
            const text = encodeURIComponent(`Check out this room: ${name} in ${location} for ₹${price}! More details at: ${window.location.href}`);
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }
    </script>
</body>
</html>